# vk_demo_bot

Демонстрационная версия бота ВК для сообществ, оказывающих платные услуги. 
Попробовать можно здесь: https://vk.com/club104855791

Бот работает на следующем стэке: 
* код на Python;
* библиотека vk_api для запросов к API ВК;
* библиотека SqlAlchemy для запросов к базе данных (PostgreSQL).

Основная цель бота: автоматизация процесса приёма и обработки обращений в группах ВК, предлагающих ограниченный перечень типовых услуг, осуществляемых дистанционно (онлайн-консультирование, репетиторство, услуги рекламы, дизайна, подготовки документов, и т.п.).


## Тестирование возможностей

Возможности бота могут быть протестированы в следующей тестовой группе ВК: https://vk.com/club104855791.

Бот из данного репозитория подключен именно к этой группе. 
Сценарий бота написан таким образом, чтобы в ответных сообщениях также подробно описать его функционал без привязки к конкретной предметной области.  


## Возможности

Бот работает на основе заранее заданных команд. Распознавание текста и намерений пользователя с помощью машинного обучения отсутствуют, так что при вводе неверных команд бот будет выдавать ошибку. 

В данном боте реализованы: 
* ветвление диалога в зависимости от команды пользователя;
* сбор ответов на типовые вопросы по заказу в отдельной ветке;
* сохранение информации, полученной в ветке оформления заказа (текста, документов, фото) в базе данных;
* отправка администратору в одном сообщении собранных ответов и документов от пользователя после завершения оформления заказа;
* "выключение" бота после завершения оформления заказа, чтобы дать возможность администратору продолжить диалог с клиентом в свободной форме и "включение" по командам от пользователя или администратора.


## Структура проекта

* Main.py - файл запуска бота. Запускает "прослушивание" longpoll-сервера и начальную обработку получаемых событий. 
* vk_functions.py - файл, содержащий вспомогательные custom-функции для работы с требуемыми методами API ВК;
* handlers.py - содержит полный алгоритм обработки событий ВК;
* messages.py - содержит тексты, которыми бот отвечает и команды, на которые он реагирует;
* keyboard.py - файл для создания клавиатур, прикреплённых к сообщениям бота;
* db.py - параметры соединения с БД;
* db_models.py - схема БД (таблицы), используемая для работы чат-бота;
* db_functions.py - файл с функциями, ответственными за взаимодействие бота с БД (DML-команды). 

В каждом файле также имеется подробное описание работы каждой части кода. 
Также есть логическая блок-схема (очень большая и развёрнутая!) с подробным описанием работы приложения. 
Её можно посмотреть тут: https://vk.cc/ccyvQE

Стиль написания кода и комментариев исходит из субъективных предположений об удобстве восприятия и может не соответствовать классическим правилам PEP-8. 
Но все замечания линтера, кроме длины строк и проблемных переносов, по возможности были учтены. 


## Запуск на локальной машине

### Шаг 0

Для запуска у вас на компьютере должен быть установлен ***python***. 
Если он не установлен, то для установки на Ubuntu Linux воспользуйтесь материалом вот этой статьи: https://phoenixnap.com/kb/how-to-install-python-3-ubuntu

Для успешного запуска проекта также потребуются дополнительные библиотеки и программы. 
Чтобы их установить на Linux, выполните в консоли следующие команды:

    sudo apt update
    sudo apt install python3.9-pip python3.9-venv git

Для установки на Windows зайдите на страницу https://www.python.org/downloads/windows/, скачайте инсталлятор последней стабильной версии и запустите установку. Затем аналогичным образом затем зайдите на страницу https://git-scm.com/download/win и установите актуальную версию Git.

### Шаг 1

Скачайте репозиторий проекта

    git clone https://github.com/SergeDSX/vk_demo_bot.git

Перейдите в папку проекта и создайте в ней виртуальное окружение.

Команды в консоли для Linux: 

    python3 -m venv env
    source env/bin/activate

Аналогично для Windows:

    python -m venv env
    env\Scripts\activate

В виртуальном окружении установите остальные требуемые библиотеки: 
    pip install -r requirments.txt

### Шаг 2

Создайте в каталоге проекта файл ***settings.py*** и укажите в нём значения для 4х переменных: 
* token - уникальный токен для получения доступа к группе ВК. Выдаётся через раздел настроек группы ВК "Работа с API". 
* group_id - внутренний id группы ВК, в которую будет подключаться бот.
* admin_id - внутренний id профиля администратора (нужен только для опций администратора в группе, например для пересылки собранной информации из БД). Обратите внимание, что для демо-режима пересылка настроена на аккаунт клиента, для корректной работы удалите строчку 423 из файла ***handlers.py*** (admin_id = vk_id). 
* db_connection - ссылка на базу данных (должна начинаться на postgresql://...). Создать её можно на сервисе https://www.elephantsql.com. Либо можете указать ссылку на БД, созданную на локальной машине.

### Дополнительно

Для удобства работы с кодом, если у вас в IDE установлен линтер, рекомендуется установить игнорирование некоторых ошибок. Например, для flake8 параметры следующие: 
     "python.linting.flake8Args": ["--ignore=E501,W504", "--verbose"]

### Шаг 3

Запуск проекта осуществляется через запуск файла ***main.py***. 
Команда в консоли соответственно: 

    python3 main.py

Если при вызове возникает ошибка, то, вероятно, это из-за того, что система не смогла найти требуемые библиотеки. 
Убедитесь, что виртуальное окружение активировано и попробуйте ещё раз. 
Также в ряде случаев ошибка может возникать из-за того, что таблицы в БД не существуют, т.е. они не создались автоматически. В этом случае сначала создайте их вручную, последовательно запуская файлы ***db.py*** и ***db_models.py***. Затем вновь запускайте ***main.py***. 


## Перспективы проекта

Данный бот создавался для решения конкретной прикладной задачи, а также фиксации достигнутого уровня мастерства его разработчика =) 
Развитие из текущего состояния в рамках данного проекта далее не планируется. 
Минимальные улучшения возможны лишь для совместимости с актуальной версией API ВК. 

В отдалённой перспективе могут быть рассмотрены:
* возможность создания аналогичного бота на базе асинхронной библиотеки (например, VkWave) и технологии SVM для создания веток сценариев бота;
* расширение использования бота на несколько сообществ ВК (на данный момент его можно использовать лишь как одно веб-приложение для одной группы, для запуска на другой группе необходимо запускать клон такого же приложения с другими настройками); 
* оптимизация работы с БД (обработка незакрытых соединений и обрыва соединений);
* выполнение задач по расписанию (отмена незавершённых заказов, периодические рассылки для пользователей или администратора);
* логирование событий. 

Указанные задачи будут решаться уже в рамках отдельного нового проекта (и, соответственно, репозитория). 